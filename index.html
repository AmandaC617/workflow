<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案工作流程管理系統 (Firebase 版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }
        .step-item { transition: all 0.3s ease; }
        .step-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .step-complete { background-color: #d1fae5; border-color: #10b981; }
        .step-active { background-color: #e0f2fe; border-color: #3b82f6; }
        .step-pending { background-color: #ffffff; border-color: #d1d5db; }
        .progress-bar { transition: width 0.5s ease; }
        .comment-item { border-left: 3px solid #3b82f6; }
        .project-card { transition: all 0.3s ease; }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal { transition: opacity 0.3s ease; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* [新增] 骨架屏動畫 */
        .skeleton-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }
        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
        }
        @keyframes pulse {
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 全螢幕載入指示器 -->
    <div id="initial-loader" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p class="text-white mt-4">正在載入應用程式...</p>
    </div>

    <!-- 登入模態框 -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-6 text-center">登入系統</h2>
            <p class="text-gray-600 mb-6 text-center">請使用 Google 帳號登入以使用專案管理系統。</p>
            <div class="flex flex-col items-center">
                <div id="g_id_onload"
                     data-client_id="733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com"
                     data-callback="handleCredentialResponse"
                     data-use_fedcm_for_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="center"></div>
            </div>
        </div>
    </div>

    <!-- 主應用程式 -->
    <div id="app" class="hidden">
        <!-- 導航欄 ... -->
        <main class="container mx-auto px-4 py-8">
            <div id="projects-view">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">我的專案</h2>
                    <button id="new-project-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md transition duration-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        新增專案
                    </button>
                </div>
                <div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 專案卡片或骨架屏將會顯示在這裡 -->
                </div>
            </div>
            <div id="project-detail-view" class="hidden"><!-- ... 專案詳情 ... --></div>
        </main>
    </div>
    
    <!-- ... 各式模態框 ... -->

    <script type="module">
        // Firebase SDK 匯入...
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithCredential, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, addDoc, doc, updateDoc, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 初始化...
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 全域變數與狀態管理...
        let currentUser = null;
        let unsubscribeProjectsListener = null;
        let unsubscribeProjectDetailListener = null;

        const initialLoader = document.getElementById('initial-loader');
        const loginModal = document.getElementById('login-modal');
        const appEl = document.getElementById('app');

        // 驗證與使用者管理...
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = { uid: user.uid, name: user.displayName, email: user.email, avatar: user.photoURL };
                initializeAppUI();
            } else {
                currentUser = null;
                initialLoader.classList.add('hidden');
                loginModal.classList.remove('hidden');
                appEl.classList.add('hidden');
                if (unsubscribeProjectsListener) unsubscribeProjectsListener();
                if (unsubscribeProjectDetailListener) unsubscribeProjectDetailListener();
            }
        });

        window.handleCredentialResponse = (response) => {
            const idToken = response.credential;
            const credential = GoogleAuthProvider.credential(idToken);
            signInWithCredential(auth, credential).catch(error => console.error("Sign-In Failed:", error));
        };
        
        // UI 初始化與渲染...
        function initializeAppUI() {
            loginModal.classList.add('hidden');
            initialLoader.classList.add('hidden');
            appEl.classList.remove('hidden');
            // ... 更新使用者資訊 UI ...
            listenForProjects();
        }

        // [修改] 渲染骨架屏的函式
        function renderSkeletonProjects() {
            const projectsContainer = document.getElementById('projects-container');
            if (!projectsContainer) return;
            projectsContainer.innerHTML = ''; // 清空舊內容
            
            // 顯示 3 個骨架卡片作為預載入提示
            for (let i = 0; i < 3; i++) {
                const skeletonCard = document.createElement('div');
                skeletonCard.className = 'skeleton-card';
                skeletonCard.innerHTML = `
                    <div class="space-y-4">
                        <div class="h-6 w-3/4 skeleton"></div>
                        <div class="space-y-2">
                            <div class="h-4 w-1/2 skeleton"></div>
                            <div class="h-4 w-1/3 skeleton"></div>
                        </div>
                        <div class="h-3 w-full skeleton"></div>
                    </div>
                `;
                projectsContainer.appendChild(skeletonCard);
            }
        }

        function listenForProjects() {
            if (unsubscribeProjectsListener) unsubscribeProjectsListener();

            // [新增] 立即顯示骨架屏
            renderSkeletonProjects();
            
            const projectsRef = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
            const q = query(projectsRef, where("members", "array-contains", currentUser.uid));

            unsubscribeProjectsListener = onSnapshot(q, (querySnapshot) => {
                const projects = [];
                querySnapshot.forEach((doc) => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                renderProjectsList(projects); // [修改] 收到真實資料後，再渲染真實列表
            }, (error) => {
                console.error("Error listening for projects: ", error);
                const projectsContainer = document.getElementById('projects-container');
                if (projectsContainer) projectsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">讀取專案時發生錯誤。</p>`;
            });
        }
        
        function renderProjectsList(projects) {
            const projectsContainer = document.getElementById('projects-container');
            if(!projectsContainer) return;
            
            projectsContainer.innerHTML = ''; // 清空骨架屏或舊資料
            if (projects.length === 0) {
                 projectsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">您尚未加入任何專案，請點擊右上角新增專案。</p>`;
                 return;
            }

            projects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card bg-white rounded-lg shadow-md overflow-hidden cursor-pointer';
                
                // 計算進度
                const totalSteps = 6; // 假設總共有6個步驟
                const completedCount = project.completedSteps ? project.completedSteps.length : 0;
                const progress = totalSteps > 0 ? Math.round((completedCount / totalSteps) * 100) : 0;

                projectCard.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 truncate">${project.name}</h3>
                        <p class="text-gray-600 mb-4 mt-1">客戶: ${project.client}</p>
                        <div class="flex items-center mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2 mr-4">
                                <div class="bg-indigo-600 h-2 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-700">${progress}%</span>
                        </div>
                    </div>`;
                projectCard.addEventListener('click', () => showProjectDetail(project.id));
                projectsContainer.appendChild(projectCard);
            });
        }

        function showProjectDetail(projectId) {
             // ... 顯示專案詳情頁，隱藏列表頁 ...
             // ... 並設定一個新的 onSnapshot 監聽器來即時更新此專案的詳細資料 ...
        }

        // 事件監聽 ...

    </script>
</body>
</html>


