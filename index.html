<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案工作流程管理系統 (Firebase 版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }
        .step-item { transition: all 0.3s ease; }
        .step-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .step-complete { background-color: #d1fae5; border-color: #10b981; }
        .step-active { background-color: #e0f2fe; border-color: #3b82f6; }
        .step-pending { background-color: #ffffff; border-color: #d1d5db; }
        .progress-bar { transition: width 0.5s ease; }
        .comment-item { border-left: 3px solid #3b82f6; }
        .project-card { transition: all 0.3s ease; }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal { transition: opacity 0.3s ease; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 全螢幕載入指示器 -->
    <div id="initial-loader" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p class="text-white mt-4">正在載入應用程式...</p>
    </div>

    <!-- 登入模態框 -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-6 text-center">登入系統</h2>
            <p class="text-gray-600 mb-6 text-center">請使用 Google 帳號登入以使用專案管理系統。</p>
            <div class="flex flex-col items-center">
                <!--
                ======================================================================
                [重要] 如何解決「The given origin is not allowed」錯誤：
                ======================================================================
                這個錯誤表示您執行此網頁的網域，尚未被授權使用這個 Client ID。
                這是一個 Google Cloud 的安全設定，無法透過修改此文件程式碼解決。
                請依照以下步驟，將執行網域加入您的授權清單：

                1. 前往 Google Cloud Console 憑證頁面。
                   您可以直接複製此連結貼到瀏覽器： https://console.cloud.google.com/apis/credentials

                2. 在「OAuth 2.0 用戶端 ID」清單中，找到並點擊您正在使用的 Client ID 名稱。
                   (它的 Client ID 結尾是 ...ths1e8u29.apps.googleusercontent.com)

                3. 進入編輯頁面後，找到「已授權的 JavaScript 來源」(Authorized JavaScript origins) 區塊。

                4. 點擊「+ 新增 URI」。

                5. 在跳出的輸入框中，**精準地**輸入以下這個網址 (請用複製貼上以避免打錯)：
                   https://storage.googleapis.com

                6. 按下 Enter 鍵或點擊旁邊空白處確認輸入。

                7. 點擊頁面最下方的 **「儲存」** 按鈕。

                8. 等待一兩分鐘讓設定生效，然後**重新整理此頁面**，即可正常登入。
                ======================================================================
                -->
                <div id="g_id_onload"
                     data-client_id="733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com"
                     data-callback="handleCredentialResponse"
                     data-use_fedcm_for_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="center"></div>
            </div>
        </div>
    </div>

    <!-- 主應用程式 (HTML 結構與之前版本大致相同，此處為簡化省略) -->
    <div id="app" class="hidden">
        <nav class="bg-indigo-600 text-white shadow-md sticky top-0 z-30"><!-- ... 導航欄 ... --></nav>
        <main class="container mx-auto px-4 py-8">
            <div id="projects-view"><!-- ... 專案列表 ... --></div>
            <div id="project-detail-view" class="hidden"><!-- ... 專案詳情 ... --></div>
        </main>
    </div>
    <!-- ... 各式模態框 ... -->

    <!-- Firebase SDK -->
    <script type="module">
        // ----------------------------------------------------------------
        // Firebase 設置與初始化
        // ----------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithCredential,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            query,
            where,
            onSnapshot,
            addDoc,
            doc,
            updateDoc,
            serverTimestamp,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // [重要] 從 Canvas 環境獲取 Firebase 配置
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {}; // Fallback to empty object if not provided

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ----------------------------------------------------------------
        // 全域變數與狀態管理
        // ----------------------------------------------------------------
        let currentUser = null;
        let unsubscribeProjectsListener = null;
        let unsubscribeProjectDetailListener = null;

        const initialLoader = document.getElementById('initial-loader');
        const loginModal = document.getElementById('login-modal');
        const appEl = document.getElementById('app');

        // ----------------------------------------------------------------
        // 驗證與使用者管理 (Authentication & User Management)
        // ----------------------------------------------------------------
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = {
                    uid: user.uid,
                    name: user.displayName,
                    email: user.email,
                    avatar: user.photoURL
                };
                initializeAppUI();
            } else {
                currentUser = null;
                initialLoader.classList.add('hidden');
                loginModal.classList.remove('hidden');
                appEl.classList.add('hidden');
                if (unsubscribeProjectsListener) unsubscribeProjectsListener();
                if (unsubscribeProjectDetailListener) unsubscribeProjectDetailListener();
            }
        });

        window.handleCredentialResponse = (response) => {
            const idToken = response.credential;
            const credential = GoogleAuthProvider.credential(idToken);
            
            signInWithCredential(auth, credential).catch((error) => {
                console.error("Google Sign-In with Firebase failed:", error);
                alert("使用 Google 登入時發生錯誤，請稍後再試。");
            });
        };
        
        const logoutBtn = document.getElementById('logout-button');
        if(logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                     if (window.google && google.accounts && google.accounts.id) {
                        google.accounts.id.disableAutoSelect();
                     }
                }).catch(error => {
                    console.error("Sign out failed:", error);
                });
            });
        }

        // ----------------------------------------------------------------
        // UI 初始化與渲染 (此處為簡化省略，完整程式碼應包含所有 UI 渲染邏輯)
        // ----------------------------------------------------------------
        
        function initializeAppUI() {
            loginModal.classList.add('hidden');
            initialLoader.classList.add('hidden');
            appEl.classList.remove('hidden');

            const userNameEl = document.getElementById('user-name');
            const userIdEl = document.getElementById('user-id');
            const userAvatarEl = document.getElementById('user-avatar');

            if(userNameEl) userNameEl.textContent = currentUser.name;
            if(userIdEl) userIdEl.textContent = currentUser.uid;
            if(userAvatarEl) userAvatarEl.src = currentUser.avatar;
            
            listenForProjects();
        }

        function listenForProjects() {
            if (unsubscribeProjectsListener) unsubscribeProjectsListener();
            
            const projectsRef = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
            const q = query(projectsRef, where("members", "array-contains", currentUser.uid));

            unsubscribeProjectsListener = onSnapshot(q, (querySnapshot) => {
                const projects = [];
                querySnapshot.forEach((doc) => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                renderProjectsList(projects);
            }, (error) => {
                console.error("Error listening for projects: ", error);
            });
        }
        
        function renderProjectsList(projects) {
            const projectsContainer = document.getElementById('projects-container');
            if(!projectsContainer) return;
            
            projectsContainer.innerHTML = ''; // 清空
            if (projects.length === 0) {
                 projectsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">您尚未加入任何專案，請點擊右上角新增專案。</p>`;
                 return;
            }

            projects.forEach(project => {
                // ... 在此處應有渲染每個 project card 的邏輯 ...
                // 為了簡潔，此處省略具體 HTML 字串，但概念與之前版本相同
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card bg-white rounded-lg shadow-md overflow-hidden cursor-pointer';
                projectCard.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800">${project.name}</h3>
                        <p class="text-gray-600 mb-4">客戶: ${project.client}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: ${project.progress || 0}%"></div>
                        </div>
                    </div>`;
                projectCard.addEventListener('click', () => showProjectDetail(project.id));
                projectsContainer.appendChild(projectCard);
            });
        }

        function showProjectDetail(projectId) {
             // ... 顯示專案詳情頁，隱藏列表頁 ...
             // ... 並設定一個新的 onSnapshot 監聽器來即時更新此專案的詳細資料 ...
        }

        // ----------------------------------------------------------------
        // 事件監聽 (此處為簡化省略，應包含所有按鈕、表單的事件監聽)
        // ----------------------------------------------------------------
        // - 新增專案按鈕
        // - 提交新專案表單 (addDoc)
        // - 標記步驟完成 (updateDoc)
        // - 新增評論 (updateDoc with arrayUnion)
        // - 邀請成員等...

    </script>
</body>
</html>


